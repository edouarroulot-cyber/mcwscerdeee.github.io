
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course GTA - Personnages</title>
    <style>
        :root {
            --track-height: 110px;
            --car-height: 90px;
            --car-width-percent: 12%;
            --color-red: #e74c3c;
            --color-blue: #3498db;
            --color-green: #2ecc71;
            --color-background: #f0f2f5;
            --color-container: #ffffff;
            --color-button: #007bff;
            --color-button-hover: #0056b3;
            --color-button-disabled: #95a5a6;
            --color-reward: #f39c12;
            --color-notification: #2ecc71;
            --color-queue: #8e44ad;
            --color-jackpot: #e74c3c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            background-image: url('https://i.ytimg.com/vi/EqbbgAUxOuM/hq720.jpg?sqp=-oaymwE7CK4FEIIDSFryq4qpAy0IARUAAAAAGAElAADIQj0AgKJD8AEB-AH-CYAC0AWKAgwIABABGFYgNSh_MA8=&rs=AOn4CLD72Wvdjx_QlSZ7hylH2G0pwKvB_A');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: var(--color-background);
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        h1 {
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            border: 2px solid #f39c12;
        }

        #raceTrack {
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #f39c12;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            box-sizing: border-box;
        }

        .track {
            width: 100%;
            height: var(--track-height);
            margin: 35px 0;
            position: relative;
            background-image: url('https://i.ibb.co/hx5yjpmn/t-l-chargement-4-Photoroom.png');
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            border: 3px solid white;
            border-radius: var(--track-height);
            box-sizing: border-box;
            overflow: hidden;
        }

        .reward-flag {
            position: absolute;
            bottom: 0;
            height: 100%;
            width: 4px;
            background-color: var(--color-reward);
            opacity: 0.6;
            z-index: 1;
        }

        .reward-flag::before {
            content: 'üíé';
            position: absolute;
            top: -28px;
            left: -8px;
            font-size: 20px;
        }

        .finish-line {
            position: absolute;
            right: calc(var(--car-width-percent) / 2);
            bottom: 0;
            height: 100%;
            width: 6px;
            background-image: repeating-linear-gradient(
                45deg,
                #000,
                #000 3px,
                #fff 3px,
                #fff 6px
            );
            z-index: 1;
        }

        .car {
            width: var(--car-width-percent);
            height: var(--car-height);
            position: absolute;
            left: 0;
            top: calc((var(--track-height) - var(--car-height)) / 2);
            transition: left 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 5px;
            z-index: 2;
        }

        #car1 {
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3ZHY0M3N2cG0wYmQ1MWY3ZXhsYzY3MXh6bnp4d3kyMXZiZnNvbjBiOCZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/ygnr4K8TFD3qM/giphy.gif');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            border-bottom: none;
        }

        #car2 {
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3dzAwejFnMW9tNjNrdzBlcGczM2xvcXZoaXowcnhzNm15endiYXBieSZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/qHlHGLmbEkJ9oPbj2C/giphy.gif');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            border-bottom: none;
        }

        #car4 {
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3Nmc5c2w0YWd1ZHQybDJyYWZtczVzaHFsbndwNnRybHdmNmZ4ajcxZSZlcD12MV9zdGlja2Vyc19yZWxhdGVkJmN0PXM/0RsKftmrYXTfa9RiU7/giphy.gif');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            border-bottom: none;
        }

        #car5 {
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3YzA3MjlodzhnaHJ3cm1yNGs3cGZydWR1NGp5cTV5c28wZGM5ejhwNiZlcD12MV9zdGlja2Vyc19yZWxhdGVkJmN0PXM/JnFF8AX6IeNdatjdcf/giphy.gif');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            border-bottom: none;
        }

        #moveButton {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            border: none;
            margin-top: 10px;
            transition: transform 0.1s, opacity 0.2s;
            padding: 10px 20px;
            border-radius: 15px;
            border: 2px solid #f39c12;
        }

        .button-icon {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 120px;
            height: 120px;
        }

        .button-text {
            color: white;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 5px;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 8px rgba(0,0,0,0.7);
        }

        #moveButton:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        #moveButton:active {
            transform: scale(0.95);
        }

        #moveButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .track span {
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #1a1a1a;
            padding: 25px 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid #f39c12;
            color: white;
        }

        .modal-content h2 {
            margin: 0;
            color: #f39c12;
        }

        .modal-content button {
            background-color: #f39c12;
            color: black;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px;
        }
        .modal-content button:hover {
            background-color: #e67e22;
        }

        #winnerRewardImage {
            width: 150px;
            height: 150px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 15px auto;
            animation: float 3s ease-in-out infinite;
        }

        #winnerRewardText {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-reward);
            margin: 10px 0;
        }

        #rewardNotification {
            position: fixed;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-notification);
            color: white;
            padding: 12px 25px;
            border-radius: 0 0 8px 8px;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: top 0.5s ease-out, opacity 0.5s ease-out;
            display: none;
            border-bottom: 2px solid #f39c12;
        }

        /* Style commun pour tous les panneaux */
        .panel {
            position: fixed;
            background-color: rgba(26, 26, 26, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 500;
            text-align: left;
            color: white;
            border: 2px solid #f39c12;
        }

        .panel-header {
            padding: 10px 15px;
            background-color: rgba(243, 156, 18, 0.2);
            border-bottom: 1px solid #f39c12;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            cursor: move;
            font-weight: bold;
            color: #f39c12;
        }

        .panel-section {
            padding: 15px;
        }

        .panel-section h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #f39c12;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 5px;
        }

        /* Panneau d'information des gains */
        #infoPanel {
            top: 20px;
            right: 20px;
            width: 280px;
        }

        #lastGain {
            font-size: 0.95em;
            font-weight: bold;
            color: var(--color-notification);
            min-height: 20px;
        }

        #gainHistory {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .history-entry {
            padding: 4px 0;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-entry .delete-btn {
            background-color: var(--color-red);
            color: white;
            border: none;
            padding: 2px 6px;
            font-size: 0.8em;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        .history-entry .delete-btn:hover {
            background-color: #c0392b;
        }

        /* Nouveau panneau des statistiques des joueurs */
        #playerStatsPanel {
            top: 20px;
            left: 20px;
            width: 350px;
        }

        .player-stats-table {
            width: 100%;
            font-size: 0.9em;
            border-collapse: collapse;
        }

        .player-stats-table th {
            text-align: left;
            padding: 8px;
            background-color: rgba(243, 156, 18, 0.1);
            border-bottom: 2px solid #f39c12;
            color: #f39c12;
        }

        .player-stats-table td {
            padding: 8px;
            border-bottom: 1px solid #333;
        }

        .player-stats-table tr:last-child td {
            border-bottom: none;
        }

        .player-name-cell {
            font-weight: bold;
            color: #f39c12;
        }

        .player-coins-cell {
            text-align: center;
        }

        .player-actions-cell {
            text-align: right;
            white-space: nowrap;
        }

        .player-action-btn {
            background-color: #f39c12;
            color: black;
            border: none;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        .player-action-btn.delete {
            background-color: var(--color-red);
            color: white;
        }

        .player-action-btn.replay {
            background-color: var(--color-green);
            color: white;
        }

        .player-action-btn:hover {
            opacity: 0.8;
        }

        .player-coins-badge {
            background-color: #f39c12;
            color: black;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .stats-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 0.9em;
        }

        .total-players, .total-coins {
            color: #f39c12;
            font-weight: bold;
        }

        /* Panneau de connexion TikFinity */
        #connectionPanel {
            bottom: 20px;
            left: 20px;
            width: 280px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-connected {
            background-color: var(--color-notification);
        }

        .status-disconnected {
            background-color: var(--color-red);
        }

        .connection-info {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 10px;
        }

        /* Panneau de file d'attente */
        #queuePanel {
            bottom: 20px;
            right: 20px;
            width: 280px;
        }

        .queue-count {
            background-color: rgba(243, 156, 18, 0.3);
            color: #f39c12;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        .queue-content {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .queue-item:last-child {
            border-bottom: none;
        }

        .queue-user {
            font-weight: bold;
            color: #f39c12;
        }

        .queue-amount {
            background-color: #f39c12;
            color: black;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        .queue-timestamp {
            font-size: 0.85em;
            color: #aaa;
        }

        .queue-empty {
            text-align: center;
            color: #777;
            font-style: italic;
            padding: 8px 0;
            font-size: 0.9em;
        }

        /* Boutons d'avancement */
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #f39c12;
        }

        .advance-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            border: none;
            transition: transform 0.3s ease, opacity 0.2s;
            padding: 10px 5px 5px 5px;
            width: auto;
            height: auto;
            position: relative;
            border-radius: 15px;
            border: 2px solid #f39c12;
        }

        .advance-button:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .advance-button:active {
            transform: scale(0.95);
        }

        .advance-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .advance-icon {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 120px;
            height: 120px;
            transition: transform 0.5s ease;
            animation: zoomInOut 2s infinite ease-in-out;
        }

        .advance-text {
            color: white;
            font-weight: bold;
            font-size: 1em;
            margin-top: 5px;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 8px rgba(0,0,0,0.7);
            transition: transform 0.3s ease;
        }

        /* Bouton principal */
        #moveButton {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            border: none;
            margin: 0;
            padding: 10px 5px 5px 5px;
            width: auto;
            height: auto;
            position: relative;
            border-radius: 20px;
            border: 2px solid #f39c12;
        }

        .button-icon {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 150px;
            height: 150px;
            transition: transform 0.5s ease;
            animation: zoomInOut 2s infinite ease-in-out;
        }

        /* Animations */
        @keyframes zoomInOut {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes zoomHover {
            0% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1.1);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-15px);
            }
            100% {
                transform: translateY(0px);
            }
        }

        @keyframes carBounce {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
            100% {
                transform: translateY(0px);
            }
        }

        .advance-button:hover .advance-icon {
            animation: zoomHover 0.5s ease forwards;
        }

        #moveButton:hover .button-icon {
            animation: zoomHover 0.5s ease forwards;
        }

        /* Animation de vibration pour les voitures */
        .car.vibrate {
            animation: carVibrate 0.3s ease-in-out;
        }

        @keyframes carVibrate {
            0% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            50% { transform: translateX(2px); }
            75% { transform: translateX(-2px); }
            100% { transform: translateX(0); }
        }

        /* Animation de saut pour les voitures */
        .car.jump {
            animation: carJump 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes carJump {
            0% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0); }
        }

        /* Animation de turbo */
        .car.turbo {
            animation: carTurbo 0.8s ease-out;
        }

        @keyframes carTurbo {
            0% { 
                filter: brightness(1);
                transform: scale(1);
            }
            50% { 
                filter: brightness(1.5);
                transform: scale(1.05);
            }
            100% { 
                filter: brightness(1);
                transform: scale(1);
            }
        }

        /* Animation de particules */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: rgba(243, 156, 18, 0.8);
            border-radius: 50%;
            pointer-events: none;
            animation: particleFloat 1s ease-out forwards;
        }

        @keyframes particleFloat {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx, 0), var(--ty, -30px));
                opacity: 0;
            }
        }

        /* R√©compenses sur les pistes */
        #finalRewardTrack1, #finalRewardTrack2, #finalRewardTrack4, #finalRewardTrack5 {
            position: absolute;
            width: 120px;
            height: 120px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            right: 1%;
            top: calc(50% - 60px);
            z-index: 1;
            animation: float 3s ease-in-out infinite;
        }

        #finalRewardTrack1 {
            background-image: url('https://i.ibb.co/SDvhSDT8/IMG-7785-Photoroom.png');
        }

        #finalRewardTrack2 {
            background-image: url('https://i.ibb.co/Y7HjdxjB/IMG-7786-1-Photoroom.png');
        }

        #finalRewardTrack4 {
            background-image: url('https://i.ibb.co/0pjVfMTt/IMG-6165.png');
        }

        #finalRewardTrack5 {
            background-image: url('https://i.ibb.co/C5M6DHcS/IMG-7356-Photoroom.png');
        }

        /* R√©compenses interm√©diaires */
        #track1-reward1, #track1-reward2, #track1-reward3,
        #track2-reward1, #track2-reward2, #track2-reward3,
        #track4-reward1, #track4-reward2, #track4-reward3,
        #track5-reward1, #track5-reward2, #track5-reward3 {
            position: absolute;
            width: 60px;
            height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 1;
            animation: float 3s ease-in-out infinite;
        }

        /* Piste 1 - C√©dric */
        #track1-reward1 {
            left: 25%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNTZkcnB4ejJsYmZyOHVxdjZjMTF2dWMyMzEwNHhreXVhbmppazRwdyZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9dHM/V8P557L80vEu4DSXRg/giphy.gif');
        }

        #track1-reward2 {
            left: 50%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3M3l0ZDlrMG1pNzJlNHpjbTNlNzRsNnY3NXF2b3I0NWM2d2J6dzVhMyZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/dKtSSD86nqgCI/giphy.gif');
        }

        #track1-reward3 {
            left: 75%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3OXR4YnV4MmF1YmFlMXVsanI4YnB6dG83bmJpNjBrZjRtNG1hbW5jdSZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/j6Sbf3ZYsbl3qLIUoP/giphy.gif');
        }

        /* Piste 2 - Thomas */
        #track2-reward1 {
            left: 25%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3cTFoemozODExNWczbXgzMDMya3R2Z2poNnY9NTJrMWxlc2RwYmcxZiZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/FAXmPgyBDxuGk/giphy.gif');
        }

        #track2-reward2 {
            left: 50%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3OWQwc3A4ZzEwbThhY3NrOXAyemZidWwwN21naTFzY3cyazk4dGp1dyZlcD12MV9zdGlja2Vyc19yZWxhdGVkJmN0PXM/J5ux8DKWQg371oJESf/giphy.gif');
        }

        #track2-reward3 {
            left: 75%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3Nm9lNXdpNm5lb3ppZG5sMndqOTV1YWRhYnZhczZiYWQ2Z2JyZDg3MiZlcD12MV9zdGlja2Vyc19yZWxhdGVkJmN0PXM/Cn5nNFO0sZLaJpno0Z/giphy.gif');
        }

        /* Piste 3 - Theo */
        #track4-reward1 {
            left: 25%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3MHJicnYwcTZrYnFibnlqbDhrbGZkNHk4NXJmdGY4Y3l2Zjc2eTNyYyZlcD12MV9zdGlja2Vzc19yZWxhdGVkJmN0PXM/y1bvDTgX4mdJVK0Jcf/giphy.gif');
        }

        #track4-reward2 {
            left: 50%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3MHJicnYwcTZrYnFibnlqbDhrbGZkNHk4NXJmdGY4Y3l2Zjc2eTNyYyZlcD12MV9zdGlja2Vzc19yZWxhdGVkJmN0PXM/8AjlMqWhoHTU8RtM69/giphy.gif');
        }

        #track4-reward3 {
            left: 75%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3YzRxM3d5cWo3YWloajExeTNvN3dzN3BxNXIzYnI1OWpibG80ZDJqdiZlcD12MV9zdGlja2Vyc19yZWxhdGVkJmN0PXM/o13arkFmBikQwMXao4/giphy.gif');
        }

        /* Piste 4 - Mark */
        #track5-reward1 {
            left: 25%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3amw2NXVlZzBwejc2dGZmb25zM2M0MzJobTJyZDIwZWd6enN6dHFwaiZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/XZy6n4mmXHLeXsIZ8v/giphy.gif');
        }

        #track5-reward2 {
            left: 50%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3Nmc5c2w0YWd1ZHQybDJyYWZtczVzaHFsbndwNnRybHdmNmZ4ajcxZSZlcD12MV9zdGlja2Vyc19yZWxhdGVkJmN0PXM/YMv6nieLSodTqE0qPr/giphy.gif');
        }

        #track5-reward3 {
            left: 75%;
            top: 35%;
            transform: translateY(-50%) translateX(-50%);
            background-image: url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3Nmc5c2w0YWd1ZHQybDJyYWZtczVzaHFsbndwNnRybHdmNmZ4ajcxZSZlcD12MV9zdGlja2Vzc19yZWxhdGVkJmN0PXM/t8CXF9TwsRNS1yiujV/giphy.gif');
        }
        
        /* Bouton de paiement */
        .payment-button {
            background-color: #f39c12;
            color: black;
            border: none;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }

        .payment-button:hover {
            background-color: #e67e22;
        }

        .payment-button:disabled {
            background-color: var(--color-button-disabled);
            cursor: not-allowed;
        }

        /* Bouton rejouer */
        .replay-button {
            background-color: var(--color-green);
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }

        .replay-button:hover {
            background-color: #27ae60;
        }

        .replay-button:disabled {
            background-color: var(--color-button-disabled);
            cursor: not-allowed;
        }

        /* Bouton de sauvegarde */
        .save-button {
            background-color: var(--color-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }

        .save-button:hover {
            background-color: #2980b9;
        }

        /* Bouton rejouer piste */
        .replay-track-button {
            background-color: #8e44ad;
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }

        .replay-track-button:hover {
            background-color: #7d3c98;
        }
    </style>
</head>
<body>
    <h1>Course GTA - Personnages</h1>

    <div id="rewardNotification"></div>

    <div id="infoPanel" class="panel">
        <div class="panel-header" id="infoPanelHeader">Informations des Gains</div>
        <div class="panel-section">
            <h3>Dernier Gain</h3>
            <div id="lastGain">Aucun gain r√©cent</div>
        </div>
        <div class="panel-section" style="border-top: 1px solid #333;">
            <h3>Historique des Gains</h3>
            <div id="gainHistory"></div>
        </div>
        <div class="panel-section" style="border-top: 1px solid #333;">
            <button class="payment-button" id="clearHistoryButton">Payer pour effacer l'historique</button>
            <button class="save-button" id="manualSaveButton">Sauvegarder</button>
        </div>
    </div>

    <!-- Nouveau panneau des statistiques des joueurs -->
    <div id="playerStatsPanel" class="panel">
        <div class="panel-header" id="playerStatsPanelHeader">Statistiques des Joueurs</div>
        <div class="panel-section">
            <div id="playerStatsTableContainer">
                <table class="player-stats-table">
                    <thead>
                        <tr>
                            <th>Joueur</th>
                            <th>Pi√®ces</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playerStatsTableBody">
                        <!-- Les donn√©es seront ins√©r√©es ici par JavaScript -->
                    </tbody>
                </table>
                <div class="stats-summary">
                    <div class="total-players">Joueurs: <span id="totalPlayersCount">0</span></div>
                    <div class="total-coins">Total: <span id="totalCoinsCount">0</span> pi√®ces</div>
                </div>
            </div>
        </div>
    </div>

    <div id="connectionPanel" class="panel">
        <div class="panel-header" id="connectionPanelHeader">Connexion TikFinity</div>
        <div class="panel-section">
            <div class="connection-status">
                <div class="status-indicator status-disconnected" id="connectionStatus"></div>
                <span id="connectionText">D√©connect√©</span>
            </div>
            <div class="connection-info">
                Connectez-vous √† TikFinity pour interagir avec le jeu.
            </div>
        </div>
    </div>

    <div id="queuePanel" class="panel">
        <div class="panel-header" id="queuePanelHeader">
            <span>File d'Attente</span>
            <span class="queue-count" id="queueCount">0 action(s)</span>
        </div>
        <div class="panel-section">
            <div class="queue-content" id="queueContent">
                <div class="queue-empty">Aucune action en attente</div>
            </div>
        </div>
    </div>

    <div id="raceTrack">
        <!-- Piste 1 - C√©dric -->
        <div class="track">
            <div id="track1-reward1"></div> 
            <div class="reward-flag" style="left: 25%;"></div>
            
            <div id="track1-reward2"></div> 
            <div class="reward-flag" style="left: 50%;"></div>
            
            <div id="track1-reward3"></div> 
            <div class="reward-flag" style="left: 75%;"></div>
            
            <div class="finish-line"></div>
            <div id="finalRewardTrack1"></div>
            <div class="car" id="car1"></div>
            <span id="pos1">0</span>
        </div>

        <!-- Piste 2 - Thomas -->
        <div class="track">
            <div id="track2-reward1"></div>
            <div class="reward-flag" style="left: 25%;"></div>

            <div id="track2-reward2"></div>
            <div class="reward-flag" style="left: 50%;"></div>

            <div id="track2-reward3"></div>
            <div class="reward-flag" style="left: 75%;"></div>
            <div class="finish-line"></div>
            <div id="finalRewardTrack2"></div>
            <div class="car" id="car2"></div>
            <span id="pos2">0</span>
        </div>

        <!-- Piste 3 - Theo -->
        <div class="track">
            <div id="track4-reward1"></div>
            <div class="reward-flag" style="left: 25%;"></div>

            <div id="track4-reward2"></div>
            <div class="reward-flag" style="left: 50%;"></div>

            <div id="track4-reward3"></div>
            <div class="reward-flag" style="left: 75%;"></div>
            <div class="finish-line"></div>
            <div id="finalRewardTrack4"></div>
            <div class="car" id="car4"></div>
            <span id="pos4">0</span>
        </div>

        <!-- Piste 4 - Mark -->
        <div class="track">
            <div id="track5-reward1"></div>
            <div class="reward-flag" style="left: 25%;"></div>

            <div id="track5-reward2"></div>
            <div class="reward-flag" style="left: 50%;"></div>

            <div id="track5-reward3"></div>
            <div class="reward-flag" style="left: 75%;"></div>
            <div class="finish-line"></div>
            <div id="finalRewardTrack5"></div>
            <div class="car" id="car5"></div>
            <span id="pos5">0</span>
        </div>
    </div>

    <div class="button-container">
        <button id="moveButton">
            <span class="button-icon" style="background-image: url('https://i.ibb.co/WNXDxn2y/IMG-7354-Photoroom.png');"></span>
            <span class="button-text">Avancer !</span>
        </button>

        <button class="advance-button" id="advance30Button">
            <span class="advance-icon" style="background-image: url('https://i.ibb.co/8DMJ0cxy/IMG-7355-Photoroom.png');"></span>
            <span class="advance-text">Avancer de 30</span>
        </button>
        <button class="advance-button" id="advance100Button">
            <span class="advance-icon" style="background-image: url('https://i.ibb.co/C5M6DHcS/IMG-7356-Photoroom.png');"></span>
            <span class="advance-text">Avancer de 100</span>
        </button>
        <button class="advance-button" id="advance500Button">
            <span class="advance-icon" style="background-image: url('https://i.ibb.co/nNy17WfL/IMG-6065.png');"></span>
            <span class="advance-text">Avancer de 500</span>
        </button>
        <button class="advance-button" id="advance1000Button">
            <span class="advance-icon" style="background-image: url('https://i.ibb.co/JMPfpWV/IMG-5851.png');"></span>
            <span class="advance-text">Avancer de 1000</span>
        </button>
    </div>

    <div id="winnerModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="winnerText"></h2>
            <div id="winnerRewardImage"></div>
            <p id="winnerRewardText"></p>
            <button id="closeModalButton">Continuer</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Les objectifs pour 4 pistes
            const GOALS = [
                25000,   // C√©dric
                10000,   // Thomas
                5000,    // Theo
                2000     // Mark
            ];

            // Fonction pour g√©n√©rer une r√©compense al√©atoire entre 50 et 150 pour Mark
            function getRandomRewardForMark() {
                return Math.floor(Math.random() * 101) + 50;
            }

            // Fonction pour g√©n√©rer une r√©compense al√©atoire entre 100 et 500 pour les autres
            function getRandomReward() {
                return Math.floor(Math.random() * 401) + 100;
            }

            // R√©compenses interm√©diaires par piste
            const INTERMEDIATE_REWARDS_PER_TRACK = [
                // Piste 1 (C√©dric)
                [{ percent: 0.25, amount: getRandomReward() }, { percent: 0.50, amount: getRandomReward() }, { percent: 0.75, amount: getRandomReward() }],
                // Piste 2 (Thomas)
                [{ percent: 0.25, amount: getRandomReward() }, { percent: 0.50, amount: getRandomReward() }, { percent: 0.75, amount: getRandomReward() }],
                // Piste 3 (Theo)
                [{ percent: 0.25, amount: getRandomReward() }, { percent: 0.50, amount: getRandomReward() }, { percent: 0.75, amount: getRandomReward() }],
                // Piste 4 (Mark) - r√©compenses entre 50 et 150
                [{ percent: 0.25, amount: getRandomRewardForMark() }, { percent: 0.50, amount: getRandomRewardForMark() }, { percent: 0.75, amount: getRandomRewardForMark() }]
            ];

            // R√©compenses finales sp√©cifiques √† chaque piste
            const FINAL_REWARD_AMOUNTS = [3000, 1088, 500, 100];

            // Liens des images de r√©compense finale
            const FINAL_REWARD_IMAGES = [
                'https://i.ibb.co/SDvhSDT8/IMG-7785-Photoroom.png', // Piste 1 (C√©dric)
                'https://i.ibb.co/Y7HjdxjB/IMG-7786-1-Photoroom.png', // Piste 2 (Thomas)
                'https://i.ibb.co/0pjVfMTt/IMG-6165.png',             // Piste 3 (Theo)
                'https://i.ibb.co/C5M6DHcS/IMG-7356-Photoroom.png'    // Piste 4 (Mark)
            ];

            let carPositions = [0, 0, 0, 0];
            let gameRunning = true;
            let rewardsCollected;

            // File d'attente pour les actions
            let actionQueue = [];
            let isProcessingQueue = false;
            const QUEUE_PROCESSING_DELAY = 1000;

            // Variables pour le son
            const soundUrls = [
                'https://files.catbox.moe/dgf9j1.mp3',
                'https://files.catbox.moe/5ed2wf.mp3',
                'https://files.catbox.moe/u9s38w.wav'
            ];
            let currentAudio = new Audio();
            let isSoundPlaying = false;
            let lastSoundIndex = -1;
            let isAudioUnlocked = false;

            // Variables pour le son des gains de pi√®ces
            const coinSoundUrl = 'https://files.catbox.moe/goq31j.mp3';
            let coinAudio = new Audio();
            let isCoinSoundPlaying = false;

            // Variables pour la connexion WebSocket
            let ws = null;
            let isConnected = false;

            // Variables pour les statistiques des joueurs
            let playerStats = {};

            // Variables pour la sauvegarde automatique
            const SAVE_KEY = 'gtaGameSave';
            let autoSaveEnabled = true;
            let lastSaveTime = 0;
            const SAVE_INTERVAL = 5000;

            const carWidthPercent = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--car-width-percent'));
            const MAX_VISUAL_PERCENT = 100 - carWidthPercent;

            const carElements = [
                document.getElementById('car1'), // C√©dric
                document.getElementById('car2'), // Thomas
                document.getElementById('car4'), // Theo
                document.getElementById('car5')  // Mark
            ];

            const posElements = [
                document.getElementById('pos1'), // C√©dric
                document.getElementById('pos2'), // Thomas
                document.getElementById('pos4'), // Theo
                document.getElementById('pos5')  // Mark
            ];

            const moveButton = document.getElementById('moveButton');
            const moveButtonText = document.querySelector('#moveButton .button-text');
            const winnerModal = document.getElementById('winnerModal');
            const winnerText = document.getElementById('winnerText');
            const winnerRewardImage = document.getElementById('winnerRewardImage');
            const winnerRewardText = document.getElementById('winnerRewardText');
            const closeModalButton = document.getElementById('closeModalButton');
            const rewardNotification = document.getElementById('rewardNotification');
            const playerStatsTableBody = document.getElementById('playerStatsTableBody');
            const totalPlayersCount = document.getElementById('totalPlayersCount');
            const totalCoinsCount = document.getElementById('totalCoinsCount');
            let notificationTimeout;

            // √âl√©ments des panneaux
            const infoPanel = document.getElementById('infoPanel');
            const infoPanelHeader = document.getElementById('infoPanelHeader');
            const lastGainEl = document.getElementById('lastGain');
            const gainHistoryEl = document.getElementById('gainHistory');
            const clearHistoryButton = document.getElementById('clearHistoryButton');
            const manualSaveButton = document.getElementById('manualSaveButton');
            
            const playerStatsPanel = document.getElementById('playerStatsPanel');
            const playerStatsPanelHeader = document.getElementById('playerStatsPanelHeader');
            
            const connectionPanel = document.getElementById('connectionPanel');
            const connectionPanelHeader = document.getElementById('connectionPanelHeader');
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionText = document.getElementById('connectionText');
            
            const queuePanel = document.getElementById('queuePanel');
            const queuePanelHeader = document.getElementById('queuePanelHeader');
            const queueCount = document.getElementById('queueCount');
            const queueContent = document.getElementById('queueContent');

            // Variables pour stocker le nom d'utilisateur
            let currentUser = "Utilisateur";

            // Fonction pour sauvegarder l'√©tat du jeu
            function saveGameState() {
                if (!autoSaveEnabled) return;
                
                const gameState = {
                    carPositions: carPositions,
                    rewardsCollected: rewardsCollected,
                    playerStats: playerStats,
                    gameRunning: gameRunning,
                    timestamp: Date.now()
                };
                
                try {
                    localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
                    lastSaveTime = Date.now();
                    console.log("Jeu sauvegard√© avec succ√®s");
                } catch (e) {
                    console.error("Erreur lors de la sauvegarde:", e);
                }
            }

            // Fonction pour charger l'√©tat du jeu
            function loadGameState() {
                try {
                    const savedState = localStorage.getItem(SAVE_KEY);
                    if (savedState) {
                        const gameState = JSON.parse(savedState);
                        
                        const saveAge = Date.now() - gameState.timestamp;
                        const MAX_SAVE_AGE = 7 * 24 * 60 * 60 * 1000;
                        
                        if (saveAge < MAX_SAVE_AGE) {
                            carPositions = gameState.carPositions || [0, 0, 0, 0];
                            rewardsCollected = gameState.rewardsCollected || resetRewards();
                            playerStats = gameState.playerStats || {};
                            gameRunning = gameState.gameRunning !== undefined ? gameState.gameRunning : true;
                            
                            console.log("Jeu charg√© depuis la sauvegarde");
                            updateVisualPositions();
                            updatePlayerStatsTable();
                            return true;
                        } else {
                            console.log("Sauvegarde trop ancienne, r√©initialisation");
                        }
                    }
                } catch (e) {
                    console.error("Erreur lors du chargement de la sauvegarde:", e);
                }
                
                resetRewards();
                return false;
            }

            function updateVisualPositions() {
                for (let i = 0; i < carElements.length; i++) {
                    const currentGoal = GOALS[i];
                    let visualPercent = (carPositions[i] / currentGoal) * MAX_VISUAL_PERCENT;
                    visualPercent = Math.min(visualPercent, MAX_VISUAL_PERCENT);
                    carElements[i].style.left = visualPercent + '%';
                    posElements[i].textContent = `${carPositions[i]}`;
                }
            }

            function resetRewards() {
                rewardsCollected = [
                    [false, false, false, false], // C√©dric
                    [false, false, false, false], // Thomas
                    [false, false, false, false], // Theo
                    [false, false, false, false]  // Mark
                ];
                return rewardsCollected;
            }

            // Fonction pour rendre les panneaux d√©pla√ßables
            function makePanelDraggable(panel, header) {
                let isDragging = false;
                let offsetX, offsetY;

                header.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    offsetX = e.clientX - panel.offsetLeft;
                    offsetY = e.clientY - panel.offsetTop;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    let newX = e.clientX - offsetX;
                    let newY = e.clientY - offsetY;
                    const maxX = window.innerWidth - panel.offsetWidth;
                    const maxY = window.innerHeight - panel.offsetHeight;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    panel.style.left = newX + 'px';
                    panel.style.top = newY + 'px';
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            // Appliquer la fonction de d√©placement √† tous les panneaux
            makePanelDraggable(infoPanel, infoPanelHeader);
            makePanelDraggable(playerStatsPanel, playerStatsPanelHeader);
            makePanelDraggable(connectionPanel, connectionPanelHeader);
            makePanelDraggable(queuePanel, queuePanelHeader);

            // Connexion WebSocket
            function connectWebSocket() {
                console.log("Tentative de connexion au serveur TikFinity...");
                ws = new WebSocket('ws://127.0.0.1:8832');

                ws.onopen = () => {
                    console.log("Connect√© au serveur TikFinity !");
                    isConnected = true;
                    updateConnectionStatus();
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.action === 'advance') {
                            console.log("Action re√ßue de TikFinity:", data);
                            addToQueue(data.user, data.amount);
                            if (!isProcessingQueue) {
                                processQueue();
                            }
                        }
                    } catch (e) {
                        console.error("Erreur en recevant le message WS:", e);
                    }
                };

                ws.onclose = () => {
                    console.log("D√©connect√© du serveur TikFinity. Reconnexion dans 3s...");
                    isConnected = false;
                    updateConnectionStatus();
                    setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = (err) => {
                    console.error("Erreur WebSocket: Assurez-vous que le 'server.js' est lanc√©.", err.message);
                    isConnected = false;
                    updateConnectionStatus();
                    ws.close();
                };
            }

            function updateConnectionStatus() {
                if (isConnected) {
                    connectionStatus.className = 'status-indicator status-connected';
                    connectionText.textContent = 'Connect√©';
                } else {
                    connectionStatus.className = 'status-indicator status-disconnected';
                    connectionText.textContent = 'D√©connect√©';
                }
            }

            connectWebSocket();

            // Fonctions de gestion de la file d'attente
            function addToQueue(user, amount) {
                const action = {
                    id: Date.now() + Math.random(),
                    user: user,
                    amount: amount,
                    timestamp: new Date()
                };

                actionQueue.push(action);
                updateQueueDisplay();
            }

            function updateQueueDisplay() {
                queueCount.textContent = `${actionQueue.length} action(s)`;

                if (actionQueue.length === 0) {
                    queueContent.innerHTML = '<div class="queue-empty">Aucune action en attente</div>';
                    return;
                }

                let html = '';
                actionQueue.forEach((action, index) => {
                    const time = action.timestamp.toLocaleTimeString('fr-FR', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    html += `
                        <div class="queue-item">
                            <div>
                                <span class="queue-user">${action.user}</span>
                                <span class="queue-timestamp">${time}</span>
                            </div>
                            <div>
                                <span class="queue-amount">+${action.amount}</span>
                            </div>
                        </div>
                    `;
                });

                queueContent.innerHTML = html;
            }

            function processQueue() {
                if (actionQueue.length === 0) {
                    isProcessingQueue = false;
                    return;
                }

                isProcessingQueue = true;
                const action = actionQueue.shift();
                updateQueueDisplay();
                currentUser = action.user;
                showRewardNotification(`${action.user} a fait avancer une voiture de ${action.amount} !`);
                advanceTrulyRandomCar(action.amount);
                setTimeout(() => {
                    processQueue();
                }, QUEUE_PROCESSING_DELAY);
            }
            
            // Fonction pour jouer les sons
            function playRandomAdvanceSound() {
                if (!isAudioUnlocked) {
                    console.log("Audio non d√©verrouill√©, son ignor√©.");
                    return;
                }

                if (isSoundPlaying) return;

                isSoundPlaying = true;

                let nextSoundIndex;
                if (soundUrls.length > 1) {
                    do {
                        nextSoundIndex = Math.floor(Math.random() * soundUrls.length);
                    } while (nextSoundIndex === lastSoundIndex);
                } else {
                    nextSoundIndex = 0;
                }

                lastSoundIndex = nextSoundIndex;
                const soundSrc = soundUrls[nextSoundIndex];

                currentAudio.src = soundSrc;

                currentAudio.play().then(() => {
                    // Lecture d√©marr√©e
                }).catch(e => {
                    if (e.name !== 'AbortError') {
                        console.error("Erreur de lecture audio:", e);
                    }
                    isSoundPlaying = false;
                });

                currentAudio.onended = () => {
                    isSoundPlaying = false;
                };

                currentAudio.onerror = () => {
                    console.error("Erreur de chargement audio");
                    isSoundPlaying = false;
                };
            }

            // Fonction pour jouer le son des pi√®ces
            function playCoinSound() {
                if (!isAudioUnlocked) {
                    console.log("Audio non d√©verrouill√©, son des pi√®ces ignor√©.");
                    return;
                }

                if (isCoinSoundPlaying) return;

                isCoinSoundPlaying = true;

                coinAudio.src = coinSoundUrl;

                coinAudio.play().then(() => {
                    // Lecture d√©marr√©e
                }).catch(e => {
                    if (e.name !== 'AbortError') {
                        console.error("Erreur de lecture audio des pi√®ces:", e);
                    }
                    isCoinSoundPlaying = false;
                });

                coinAudio.onended = () => {
                    isCoinSoundPlaying = false;
                };

                coinAudio.onerror = () => {
                    console.error("Erreur de chargement audio des pi√®ces");
                    isCoinSoundPlaying = false;
                };
            }

            // Fonction pour cr√©er des particules d'effet
            function createParticles(element, count = 5) {
                const rect = element.getBoundingClientRect();
                const trackRect = element.parentElement.getBoundingClientRect();
                
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    
                    const x = rect.left + rect.width / 2 - trackRect.left;
                    const y = rect.top + rect.height / 2 - trackRect.top;
                    
                    const tx = (Math.random() - 0.5) * 40;
                    const ty = -Math.random() * 30 - 10;
                    
                    particle.style.setProperty('--tx', `${tx}px`);
                    particle.style.setProperty('--ty', `${ty}px`);
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    
                    element.parentElement.appendChild(particle);
                    
                    setTimeout(() => {
                        if (particle.parentElement) {
                            particle.parentElement.removeChild(particle);
                        }
                    }, 1000);
                }
            }

            // Fonction pour appliquer des effets visuels
            function applyVisualEffects(carElement, amount) {
                carElement.classList.remove('vibrate', 'jump', 'turbo');
                
                if (amount >= 1000) {
                    carElement.classList.add('turbo');
                    createParticles(carElement, 15);
                } else if (amount >= 100) {
                    carElement.classList.add('jump');
                    createParticles(carElement, 8);
                } else {
                    carElement.classList.add('vibrate');
                    createParticles(carElement, 3);
                }
                
                setTimeout(() => {
                    carElement.classList.remove('vibrate', 'jump', 'turbo');
                }, 800);
            }

            // Fonctions du jeu
            function updateGainPanels(message) {
                lastGainEl.textContent = message;

                const newEntry = document.createElement('div');
                newEntry.className = 'history-entry';
                newEntry.innerHTML = `
                    <span>${message}</span>
                    <button class="delete-btn" data-message="${message}">X</button>
                `;

                gainHistoryEl.prepend(newEntry);
                newEntry.querySelector('.delete-btn').addEventListener('click', function() {
                    this.parentElement.remove();
                });
            }

            function showRewardNotification(message) {
                if (notificationTimeout) {
                    clearTimeout(notificationTimeout);
                }

                rewardNotification.textContent = message;
                rewardNotification.style.display = 'block';
                rewardNotification.style.opacity = 1;
                rewardNotification.style.top = '20px';

                notificationTimeout = setTimeout(() => {
                    rewardNotification.style.opacity = 0;
                    rewardNotification.style.top = '0px';
                    setTimeout(() => { 
                        rewardNotification.style.display = 'none'; 
                    }, 500);
                }, 3000);
            }

            function getCarColorName(index) {
                switch (index) {
                    case 0: return 'C√©dric';
                    case 1: return 'Thomas';
                    case 2: return 'Theo';
                    case 3: return 'Mark';
                    default: return '';
                }
            }

            // Fonction pour mettre √† jour les statistiques des joueurs
            function updatePlayerStats(user, amount) {
                if (!playerStats[user]) {
                    playerStats[user] = 0;
                }
                playerStats[user] += amount;
                updatePlayerStatsTable();
            }

            // Fonction pour afficher les statistiques des joueurs dans le tableau
            function updatePlayerStatsTable() {
                const players = Object.keys(playerStats);
                const totalPlayers = players.length;
                const totalCoins = players.reduce((sum, player) => sum + playerStats[player], 0);
                
                totalPlayersCount.textContent = totalPlayers;
                totalCoinsCount.textContent = totalCoins;

                if (players.length === 0) {
                    playerStatsTableBody.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: center; padding: 20px; color: #777; font-style: italic;">
                                Aucune statistique disponible
                            </td>
                        </tr>
                    `;
                    return;
                }

                let html = '';
                players.forEach((user) => {
                    const coins = playerStats[user];
                    html += `
                        <tr>
                            <td class="player-name-cell">${user}</td>
                            <td class="player-coins-cell">
                                <span class="player-coins-badge">${coins} pi√®ces</span>
                            </td>
                            <td class="player-actions-cell">
                                <button class="player-action-btn replay" data-user="${user}" data-coins="${coins}">Rejouer</button>
                                <button class="player-action-btn delete" data-user="${user}">X</button>
                            </td>
                        </tr>
                    `;
                });

                playerStatsTableBody.innerHTML = html;

                // Ajouter les √©v√©nements pour les boutons
                document.querySelectorAll('.player-action-btn.delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const user = this.getAttribute('data-user');
                        if (confirm(`Supprimer ${user} des statistiques ?`)) {
                            delete playerStats[user];
                            updatePlayerStatsTable();
                            showRewardNotification(`${user} supprim√© des statistiques`);
                            saveGameState();
                        }
                    });
                });

                document.querySelectorAll('.player-action-btn.replay').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const user = this.getAttribute('data-user');
                        const coins = parseInt(this.getAttribute('data-coins'));
                        
                        if (coins >= 1) {
                            playerStats[user] = coins - 1;
                            updatePlayerStatsTable();
                            
                            advanceTrulyRandomCar(1);
                            
                            const replayMessage = `${user} a rejou√© une course (-1 pi√®ce)`;
                            updateGainPanels(replayMessage);
                            showRewardNotification(`${user} a rejou√© une course ! -1 pi√®ce`);
                            saveGameState();
                        } else {
                            showRewardNotification(`${user} n'a pas assez de pi√®ces pour rejouer !`);
                        }
                    });
                });
            }

            // Fonction pour avancer une voiture sp√©cifique
            function advanceCar(carIndex, amount) {
                if (!gameRunning || rewardsCollected[carIndex][3]) return;

                playRandomAdvanceSound();

                const oldPosition = carPositions[carIndex];
                carPositions[carIndex] += amount;
                const newPosition = carPositions[carIndex];
                const currentGoal = GOALS[carIndex];

                let visualPercent = (newPosition / currentGoal) * MAX_VISUAL_PERCENT;
                visualPercent = Math.min(visualPercent, MAX_VISUAL_PERCENT);
                
                applyVisualEffects(carElements[carIndex], amount);
                carElements[carIndex].style.left = visualPercent + '%';
                posElements[carIndex].textContent = `${newPosition}`;

                let characterName = getCarColorName(carIndex);
                
                // R√©compenses interm√©diaires
                const trackRewards = INTERMEDIATE_REWARDS_PER_TRACK[carIndex];
                for (let i = 0; i < trackRewards.length; i++) {
                    const rewardInfo = trackRewards[i];
                    const rewardStepForThisCar = currentGoal * rewardInfo.percent; 

                    if (newPosition >= rewardStepForThisCar && oldPosition < rewardStepForThisCar && !rewardsCollected[carIndex][i]) {
                        rewardsCollected[carIndex][i] = true;
                        
                        // Reg√©n√©rer une r√©compense al√©atoire pour le prochain passage
                        if (carIndex === 3) { // Mark
                            const newReward = getRandomRewardForMark();
                            INTERMEDIATE_REWARDS_PER_TRACK[carIndex][i].amount = newReward;
                        } else {
                            const newReward = getRandomReward();
                            INTERMEDIATE_REWARDS_PER_TRACK[carIndex][i].amount = newReward;
                        }

                        const rewardMessage = `${characterName} gagne ${rewardInfo.amount} pi√®ces ! (${currentUser})`;
                        showRewardNotification(rewardMessage);
                        updateGainPanels(rewardMessage);
                        playCoinSound();
                        updatePlayerStats(currentUser, rewardInfo.amount);
                        saveGameState();
                    }
                }

                // Logique de fin de jeu - maintenant se r√©initialise automatiquement
                const finalRewardIndex = 3;
                if (newPosition >= currentGoal && oldPosition < currentGoal && !rewardsCollected[carIndex][finalRewardIndex]) {
                    rewardsCollected[carIndex][finalRewardIndex] = true;
                    const finalRewardAmount = FINAL_REWARD_AMOUNTS[carIndex];
                    const finalMessage = `${characterName} a termin√© ! ${currentUser} remporte ${finalRewardAmount} pi√®ces !`;
                    
                    updateGainPanels(finalMessage);
                    showRewardNotification(finalMessage);
                    playCoinSound();
                    updatePlayerStats(currentUser, finalRewardAmount);
                    
                    // Afficher la modal de victoire
                    winnerText.textContent = `${characterName} a gagn√© la course !`;
                    winnerRewardImage.style.backgroundImage = `url('${FINAL_REWARD_IMAGES[carIndex]}')`;
                    winnerRewardText.textContent = `${currentUser} remporte ${finalRewardAmount} pi√®ces !`;
                    winnerModal.style.display = 'flex';
                    
                    // R√©initialiser automatiquement la piste apr√®s un d√©lai
                    setTimeout(() => {
                        resetSingleTrack(carIndex);
                        winnerModal.style.display = 'none';
                    }, 2000);
                    
                    saveGameState();
                }
            }

            // Fonction pour r√©initialiser une seule piste
            function resetSingleTrack(carIndex) {
                carPositions[carIndex] = 0;
                rewardsCollected[carIndex] = [false, false, false, false];
                carElements[carIndex].style.left = '0%';
                
                // R√©g√©n√©rer les r√©compenses interm√©diaires
                const trackRewards = INTERMEDIATE_REWARDS_PER_TRACK[carIndex];
                for (let i = 0; i < trackRewards.length; i++) {
                    if (carIndex === 3) { // Mark
                        INTERMEDIATE_REWARDS_PER_TRACK[carIndex][i].amount = getRandomRewardForMark();
                    } else {
                        INTERMEDIATE_REWARDS_PER_TRACK[carIndex][i].amount = getRandomReward();
                    }
                }
                
                gameRunning = true;
                moveButton.disabled = false;
                if (moveButtonText) moveButtonText.textContent = "Avancer !";
                
                document.querySelectorAll('.advance-button').forEach(button => {
                    button.disabled = false;
                });
                
                showRewardNotification(`Piste de ${getCarColorName(carIndex)} r√©initialis√©e automatiquement !`);
                saveGameState();
            }

            // Fonction pour avancer une voiture al√©atoire
            function advanceTrulyRandomCar(amount) {
                if (!gameRunning) return;
                const carIndex = Math.floor(Math.random() * carElements.length);
                advanceCar(carIndex, amount);
                saveGameState();
            }

            function resetGame() {
                winnerModal.style.display = 'none';
                carPositions = [0, 0, 0, 0];
                gameRunning = true;
                moveButton.disabled = false;
                if (moveButtonText) moveButtonText.textContent = "Avancer !";
                document.querySelectorAll('.advance-button').forEach(button => {
                    button.disabled = false;
                });
                resetRewards();
                for (let i = 0; i < carElements.length; i++) {
                    carElements[i].style.left = '0%';
                }
                saveGameState();
            }

            // Charger l'√©tat du jeu au d√©marrage
            const gameLoaded = loadGameState();
            if (gameLoaded) {
                updateVisualPositions();
                updatePlayerStatsTable();
                showRewardNotification("Progression pr√©c√©dente charg√©e avec succ√®s !");
            }

            // Mettre en place la sauvegarde automatique p√©riodique
            setInterval(() => {
                if (autoSaveEnabled && Date.now() - lastSaveTime > SAVE_INTERVAL) {
                    saveGameState();
                }
            }, 2000);

            // Sauvegarder aussi quand l'utilisateur quitte la page
            window.addEventListener('beforeunload', () => {
                saveGameState();
            });

            // √âcouteurs d'√©v√©nements
            moveButton.addEventListener('click', () => {
                if (!isAudioUnlocked) isAudioUnlocked = true;
                advanceTrulyRandomCar(1);
            });
            
            closeModalButton.addEventListener('click', () => {
                winnerModal.style.display = 'none';
            });
            
            // Bouton pour effacer l'historique
            clearHistoryButton.addEventListener('click', () => {
                gainHistoryEl.innerHTML = '';
                showRewardNotification("Historique des gains effac√© !");
            });

            // Bouton de sauvegarde manuelle
            manualSaveButton.addEventListener('click', () => {
                saveGameState();
                showRewardNotification("Jeu sauvegard√© manuellement !");
            });

            // Boutons d'avancement suppl√©mentaires
            document.getElementById('advance30Button').addEventListener('click', () => {
                if (!isAudioUnlocked) isAudioUnlocked = true;
                advanceTrulyRandomCar(30);
            });
            document.getElementById('advance100Button').addEventListener('click', () => {
                if (!isAudioUnlocked) isAudioUnlocked = true;
                advanceTrulyRandomCar(100);
            });
            document.getElementById('advance500Button').addEventListener('click', () => {
                if (!isAudioUnlocked) isAudioUnlocked = true;
                advanceTrulyRandomCar(500);
            });
            document.getElementById('advance1000Button').addEventListener('click', () => {
                if (!isAudioUnlocked) isAudioUnlocked = true;
                advanceTrulyRandomCar(1000);
            });

            // Initialiser l'affichage des statistiques des joueurs
            updatePlayerStatsTable();

        });
    </script>
</body>
</html>
